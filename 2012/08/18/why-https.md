# 为什么HTTPS是安全的?

豆瓣上看到一篇日志[《为什么没人喜欢学习高等数学》][1]，里面一段话很有意思：
>如果是我来编写大学数学教材，我会争取让每一个在大学里读过数学课的人都能回答这样的问题：为什么人们能精确预测几十年后的日食，却没法精确预测明天的天气；为什么人们可以通过 https 安全地浏览网页而不会被监听；为什么全球变暖的速度超过一个界限就变得不可逆了；为什么把文本文件压缩成 zip 体积会减少很多，而 mp3 文件压缩成 zip 大小却几乎不变；民生统计指标到底应该采用平均数还是中位数；当人们说两种乐器声音的音高相同而音色不同的时候到底是什么意思⋯⋯这不是什么「趣味数学」，这就是数学。基础、重要、深刻、美的数学。

这几个问题都挺好玩，想尝试一一解释。对于HTTPS，如果单纯从数学角度的话，就是RSA算法了。当然实际应用中还会有其他问题需要解决，比如根证书。

## HTTP v.s. HTTPS

说到HTTPS是安全的，其实是HTTPS相对于HTTP是安全的，两者完成的是相同的任务。

## 一个网页登录的例子

<table>
<tr><td>用户</td><td>-></td><td>服务器</td></tr>
<tr>
<td> {username: myname, password: mypas123} </td> <td> -> </td>
<td> {username: myname, password: mypas123} </td>
</tr>
</table>

这样就完成了一个简单的登录过程，但是网络环境总是不纯洁的。

<table>
<tr><td>用户</td><td>></td><td>窃听者</td><td>></td><td>服务器</td></tr>
<tr>
<td> {username: myname, password: mypas123} </td> <td> > </td>
<td> {username: myname, password: mypas123} </td> <td> > </td>
<td> {username: myname, password: mypas123} </td>
</tr>
</table>

用户名密码就这样被窃听者获取了。用户名密码用明文传输，这就是为什么HTTP不安全。

## [RSA算法] [wiki-rsa]

```math
c = m^e mod n
m = c^d mod n
```

适当的选择(e,d,n)，使得这两个式子成立。这两个函数互为加密解密函数。

假设：
m - message（明文消息）
c - cypher（加密消息）
那么：
n - 公钥
d - 私钥

*RSA之所以安全是因为，从n推导出d很难。也就是拿到公钥的人没法生成相应的私钥。*

## 加密

1. 服务器选择(e,d,n)
2. 服务器将公钥(n)发送给用户（怎么发？）
3. 用户将消息加密(m -> c)	
4. 用户将密文(c)发送给服务器
5. 服务器用私钥(d)解密

反过来，服务器加密消息发给用户，用户解密的过程则称为签名。

这样没有私钥(d)的人无论如何无法解密密文(c)。

## 中间人攻击

加密的安全性基于用户拿到了真正的公钥。假设窃听者控制了“网线”。

用户 <--> 窃听者 <--> 服务器

1. 窃听者代替服务器发给用户窃听者的公钥
2. 用户用窃听者的公钥加密消息
3. 窃听者用自己的密钥解密用户的密文
4. 窃听者用服务器的公钥发送消息给服务器

由于用户没有服务器的公钥

1. 用户不知道与自己通信的是服务器还是窃听者
2. 服务器不知道消息是否来自用户
3. 窃听者为所欲为

## 可信赖的第三方

被窃听的问题出在，用户没有拿到真正的服务器的公钥。可信赖的第三方应运而生。我们称之为CA。

1. CA有自己的私钥公钥对
2. CA的公钥分布非常广泛（各种主流浏览器，IE、Chrome、Firefox...）

1. 服务器将公钥发给CA
2. CA验明服务器正身
3. CA发送数字签名给服务器（SSL/TLS Certificate (.crt)）

生成公钥私钥(e,d,n) <--> CA <--> 公钥(n)分发 <--> 用户（浏览器根证书）
生成公钥私钥(e,d,n) <--> 服务器 --> 公钥签名请求 --> CA --> 验明服务器正身（打电话还是...?） --> 签名公钥(.crt) --> 服务器

新的请求流程：

1. 用户请求服务器的SSL/TSL证书
2. 用户使用CA的公钥验证该证书的签名（用CA的公钥解密证书，如果解得开，对比证书里的域名和访问的域名是否一致）
3. 如果CA是可信的，并且签名验证通过，那么信任该服务器
4. 证书里已经包含有该服务器的公钥！
5. 用户终于拿到真正的服务器的公钥了，接下来和往常一样。

到这里，HTTP就变成HTTPS了。

## 总结：什么是HTTPS？

1. 通信是*加密*的
2. 通信的对象被*验明正身*了的（通过CA）

没了。

## HTTPS也没有那么安全

HTTPS的安全性基于，CA是可信的，验证服务器是通过域名。

1. 随便安装根证书是危险的。只安装可信赖的根证书（比如12306.cn）
2. 检查URL是否是你真正要访问的（douban.com v.s. douba.com）
3. Big brother is watching you. 老大哥是否持有CA的私钥，这是个问题。







[1]: http://www.douban.com/note/182405697/
[wiki-rsa]: http://zh.wikipedia.org/wiki/RSA%E5%8A%A0%E5%AF%86%E6%BC%94%E7%AE%97%E6%B3%95 "RSA加密算法"


